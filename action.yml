name: "Pull Request Deploy"
description: "A GitHub action to automate the deployment of pull requests"
branding:
  icon: "cloud"
  color: "blue"

inputs:
  context:
    description: Directory in the repository where the Dockerfile is located
    required: false
    default: .
  dockerfile:
    description: Path to the Dockerfile
    required: false
    default: Dockerfile
  exposed_port:
    description: Port to expose in the container
    required: true
  envs:
    description: Environment variables to pass to the container (multi-line string)
    required: false
  github_token:
    description: GitHub token to authenticate API requests
    required: true
  host_volume_path:
    description: Host volume path on the server
    required: false
  container_volume_path:
    description: Container volume path
    required: false
  comment_id:
    description: ID of the comment to update
    required: false

outputs:
  preview-url:
    description: "Preview URL"
    value: ${{ steps.deploy.outputs.preview-url }}

runs:
  using: 'composite'
  steps:
    - id: deploy
      name: Deploy Pull Request
      shell: bash
      run: |
        sshpass -p ${{ env.PASSWORD }} ssh -o StrictHostKeyChecking=no -p ${{ env.PORT }} ${{ env.USERNAME }}@${{ env.HOST }} \
          "GITHUB_TOKEN='${{ inputs.github_token }}' \
          CONTEXT='${{ inputs.context }}' \
          DOCKERFILE='${{ inputs.dockerfile }}' \
          EXPOSED_PORT='${{ inputs.exposed_port }}' \
          ENVS='${{ inputs.envs }}' \
          REPO_URL='${{ github.event.repository.clone_url }}' \
          PR_ID='pr_${{ github.event.repository.id }}_${{ github.event.number }}' \
          PR_ACTION='${{ github.event.action }}' \
          bash -c 'echo ${{ env.PASSWORD }} | sudo -SE pr-deploy'" | tee "/tmp/preview_${{ github.run_id }}.txt"

        PREVIEW_URL=$(tail -n 1 "/tmp/preview_${{ github.run_id }}.txt")
        echo "preview-url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
